<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BasketballArchetypeCollector.ViewModels"
             xmlns:controls="clr-namespace:BasketballArchetypeCollector.Controls"
             xmlns:models="clr-namespace:BasketballArchetypeCollector.Models"
             x:Class="BasketballArchetypeCollector.Views.PackOpeningPage"
             x:DataType="vm:PackOpeningViewModel"
             BackgroundColor="#0a0a0a"
             Shell.NavBarIsVisible="False">

    <Grid>
        <!-- Cool Loading State -->
        <Grid IsVisible="{Binding IsOpening}"
              VerticalOptions="Center"
              HorizontalOptions="Center">
            <VerticalStackLayout Spacing="24" Padding="40">
                <!-- Pack Name with glow effect -->
                <Label Text="{Binding Pack.Name}"
                       FontFamily="OrbitronBold"
                       FontSize="28"
                       TextColor="#fbbf24"
                       HorizontalTextAlignment="Center">
                    <Label.Shadow>
                        <Shadow Brush="#fbbf24"
                                Offset="0,0"
                                Radius="20"
                                Opacity="0.6" />
                    </Label.Shadow>
                </Label>

                <!-- Animated Card Stack -->
                <Grid HeightRequest="120" WidthRequest="120" HorizontalOptions="Center">
                    <!-- Background cards (stacked effect) -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="#1e293b"
                            Rotation="-12"
                            Opacity="0.4"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="#334155"
                            Rotation="-6"
                            Opacity="0.6"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="#475569"
                            Rotation="0"
                            Opacity="0.8"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <!-- Top card with shimmer -->
                    <Border StrokeShape="RoundRectangle 12"
                            Stroke="#f97316"
                            StrokeThickness="2"
                            BackgroundColor="#1e293b"
                            Rotation="6"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center">
                        <Border.Shadow>
                            <Shadow Brush="#f97316"
                                    Offset="0,0"
                                    Radius="15"
                                    Opacity="0.5" />
                        </Border.Shadow>
                        <Label Text="?"
                               FontFamily="OrbitronBold"
                               FontSize="36"
                               TextColor="#f97316"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Border>
                </Grid>

                <!-- Loading message -->
                <Label Text="{Binding LoadingMessage}"
                       FontFamily="InterSemiBold"
                       FontSize="18"
                       TextColor="White"
                       HorizontalTextAlignment="Center" />

                <!-- Progress bar -->
                <Grid WidthRequest="250" HeightRequest="8" HorizontalOptions="Center">
                    <Border StrokeShape="RoundRectangle 4"
                            BackgroundColor="#1e293b"
                            HeightRequest="8" />
                    <Border StrokeShape="RoundRectangle 4"
                            BackgroundColor="#f97316"
                            HeightRequest="8"
                            HorizontalOptions="Start"
                            WidthRequest="{Binding LoadingProgress, Converter={StaticResource ProgressToWidthConverter}}">
                        <Border.Shadow>
                            <Shadow Brush="#f97316"
                                    Offset="0,0"
                                    Radius="8"
                                    Opacity="0.7" />
                        </Border.Shadow>
                    </Border>
                </Grid>

                <!-- Progress percentage -->
                <Label Text="{Binding LoadingProgress, StringFormat='{0:F0}%'}"
                       FontFamily="OrbitronBold"
                       FontSize="14"
                       TextColor="#64748b"
                       HorizontalTextAlignment="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Cards Revealed -->
        <Grid IsVisible="{Binding IsOpening, Converter={StaticResource InvertedBoolConverter}}"
              RowDefinitions="Auto,*,Auto"
              Padding="16">

            <!-- Pack Name -->
            <Label Grid.Row="0"
                   Text="{Binding Pack.Name}"
                   FontFamily="OrbitronBold"
                   FontSize="24"
                   TextColor="#fbbf24"
                   HorizontalTextAlignment="Center"
                   Margin="0,20,0,20">
                <Label.Shadow>
                    <Shadow Brush="#fbbf24"
                            Offset="0,0"
                            Radius="15"
                            Opacity="0.4" />
                </Label.Shadow>
            </Label>

            <!-- Cards -->
            <ScrollView Grid.Row="1">
                <FlexLayout Direction="Row"
                            Wrap="Wrap"
                            JustifyContent="Center"
                            AlignItems="Start"
                            BindableLayout.ItemsSource="{Binding Cards}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:Player">
                            <controls:PlayerCard Player="{Binding}"
                                                 CardSize="Medium"
                                                 Margin="8">
                                <controls:PlayerCard.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PackOpeningViewModel}}, Path=ViewCardCommand}"
                                                          CommandParameter="{Binding}" />
                                </controls:PlayerCard.GestureRecognizers>
                            </controls:PlayerCard>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>
            </ScrollView>

            <!-- Bottom Actions -->
            <VerticalStackLayout Grid.Row="2" Spacing="12" Margin="0,20,0,0">
                <Label Text="Tap a card to view details"
                       FontFamily="InterRegular"
                       FontSize="12"
                       TextColor="#64748b"
                       HorizontalTextAlignment="Center" />

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <!-- Close -->
                    <Button Grid.Column="0"
                            Text="Close"
                            Command="{Binding GoBackCommand}"
                            BackgroundColor="#334155"
                            TextColor="White"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50" />

                    <!-- Sell All -->
                    <Button Grid.Column="1"
                            Text="{Binding SellAllValue, StringFormat='Sell All ({0})'}"
                            Command="{Binding SellAllCommand}"
                            BackgroundColor="#dc262620"
                            TextColor="#ef4444"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50"
                            BorderColor="#ef4444"
                            BorderWidth="1" />

                    <!-- Open Another -->
                    <Button Grid.Column="2"
                            Text="Open Another"
                            Command="{Binding OpenAnotherCommand}"
                            BackgroundColor="#f97316"
                            TextColor="White"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50" />
                </Grid>

                <controls:CoinDisplay Coins="{Binding Coins}"
                                      HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Initial Open Button (before pack is opened) -->
        <VerticalStackLayout IsVisible="{Binding Cards.Count, Converter={StaticResource ZeroToVisibleConverter}}"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="24">
            <Label Text="{Binding Pack.Name}"
                   FontFamily="OrbitronBold"
                   FontSize="32"
                   TextColor="#fbbf24"
                   HorizontalTextAlignment="Center">
                <Label.Shadow>
                    <Shadow Brush="#fbbf24"
                            Offset="0,0"
                            Radius="20"
                            Opacity="0.5" />
                </Label.Shadow>
            </Label>

            <!-- Pack icon with glow -->
            <Border StrokeShape="RoundRectangle 24"
                    BackgroundColor="#1e293b"
                    Stroke="#f97316"
                    StrokeThickness="3"
                    Padding="30"
                    HorizontalOptions="Center">
                <Border.Shadow>
                    <Shadow Brush="#f97316"
                            Offset="0,0"
                            Radius="30"
                            Opacity="0.4" />
                </Border.Shadow>
                <Label Text="ðŸ“¦"
                       FontSize="80"
                       HorizontalTextAlignment="Center" />
            </Border>

            <Button Text="Open Pack"
                    Command="{Binding OpenPackCommand}"
                    BackgroundColor="#f97316"
                    TextColor="White"
                    FontFamily="OrbitronBold"
                    FontSize="20"
                    CornerRadius="16"
                    Padding="50,18"
                    HorizontalOptions="Center">
                <Button.Shadow>
                    <Shadow Brush="#f97316"
                            Offset="0,4"
                            Radius="15"
                            Opacity="0.5" />
                </Button.Shadow>
            </Button>

            <Button Text="Go Back"
                    Command="{Binding GoBackCommand}"
                    BackgroundColor="Transparent"
                    TextColor="#94a3b8"
                    FontFamily="InterSemiBold"
                    HorizontalOptions="Center" />
        </VerticalStackLayout>
    </Grid>
</ContentPage>
