<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BasketballArchetypeCollector.ViewModels"
             xmlns:controls="clr-namespace:BasketballArchetypeCollector.Controls"
             xmlns:models="clr-namespace:BasketballArchetypeCollector.Models"
             x:Class="BasketballArchetypeCollector.Views.PackOpeningPage"
             x:DataType="vm:PackOpeningViewModel"
             BackgroundColor="#0a0a0a"
             Shell.NavBarIsVisible="False">

    <Grid>
        <!-- Error Banner (shown at top when errors occur) -->
        <Border IsVisible="{Binding HasError}"
                BackgroundColor="#7f1d1d"
                Padding="16"
                VerticalOptions="Start"
                ZIndex="100">
            <VerticalStackLayout Spacing="8">
                <Label Text="Error"
                       FontFamily="InterBold"
                       FontSize="16"
                       TextColor="#fca5a5" />
                <Label Text="{Binding ErrorMessage}"
                       FontFamily="InterRegular"
                       FontSize="14"
                       TextColor="#fecaca"
                       LineBreakMode="WordWrap" />
            </VerticalStackLayout>
        </Border>

        <!-- Cool Loading State -->
        <Grid IsVisible="{Binding ShowLoadingView}"
              VerticalOptions="Center"
              HorizontalOptions="Center">
            <VerticalStackLayout Spacing="24" Padding="40">
                <!-- Pack Name with glow effect -->
                <Label Text="{Binding Pack.Name}"
                       FontFamily="OrbitronBold"
                       FontSize="28"
                       TextColor="#fbbf24"
                       HorizontalTextAlignment="Center">
                    <Label.Shadow>
                        <Shadow Brush="#fbbf24"
                                Offset="0,0"
                                Radius="20"
                                Opacity="0.6" />
                    </Label.Shadow>
                </Label>

                <!-- Animated Card Stack -->
                <Grid x:Name="CardStackContainer"
                      HeightRequest="140"
                      WidthRequest="140"
                      HorizontalOptions="Center">
                    <!-- Background cards (stacked effect) -->
                    <Border x:Name="Card1"
                            StrokeShape="RoundRectangle 12"
                            BackgroundColor="#1e293b"
                            Rotation="-12"
                            Opacity="0.4"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <Border x:Name="Card2"
                            StrokeShape="RoundRectangle 12"
                            BackgroundColor="#334155"
                            Rotation="-6"
                            Opacity="0.6"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <Border x:Name="Card3"
                            StrokeShape="RoundRectangle 12"
                            BackgroundColor="#475569"
                            Rotation="0"
                            Opacity="0.8"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center" />
                    <!-- Top card with glow - this one animates -->
                    <Border x:Name="TopCard"
                            StrokeShape="RoundRectangle 12"
                            Stroke="#f97316"
                            StrokeThickness="2"
                            BackgroundColor="#1e293b"
                            Rotation="6"
                            HeightRequest="100"
                            WidthRequest="70"
                            HorizontalOptions="Center"
                            VerticalOptions="Center">
                        <Border.Shadow>
                            <Shadow Brush="#f97316"
                                    Offset="0,0"
                                    Radius="20"
                                    Opacity="0.7" />
                        </Border.Shadow>
                        <Label Text="?"
                               FontFamily="OrbitronBold"
                               FontSize="36"
                               TextColor="#f97316"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Border>
                </Grid>

                <!-- Loading message -->
                <Label Text="{Binding LoadingMessage}"
                       FontFamily="InterSemiBold"
                       FontSize="18"
                       TextColor="White"
                       HorizontalTextAlignment="Center" />

                <!-- Progress bar -->
                <Grid WidthRequest="250" HeightRequest="8" HorizontalOptions="Center">
                    <Border StrokeShape="RoundRectangle 4"
                            BackgroundColor="#1e293b"
                            HeightRequest="8" />
                    <Border StrokeShape="RoundRectangle 4"
                            BackgroundColor="#f97316"
                            HeightRequest="8"
                            HorizontalOptions="Start"
                            WidthRequest="{Binding ProgressBarWidth}">
                        <Border.Shadow>
                            <Shadow Brush="#f97316"
                                    Offset="0,0"
                                    Radius="8"
                                    Opacity="0.7" />
                        </Border.Shadow>
                    </Border>
                </Grid>

                <!-- Progress percentage -->
                <Label Text="{Binding LoadingProgress, StringFormat='{0:F0}%'}"
                       FontFamily="OrbitronBold"
                       FontSize="14"
                       TextColor="#64748b"
                       HorizontalTextAlignment="Center" />

                <!-- Navigation hint -->
                <Label Text="Estimated time: 2 minutes"
                       FontFamily="InterRegular"
                       FontSize="12"
                       TextColor="#475569"
                       HorizontalTextAlignment="Center"
                       Margin="0,8,0,0" />

                <!-- View Live Creation Button -->
                <Button Text="View Crest Creation"
                        Command="{Binding ViewLiveCreationCommand}"
                        BackgroundColor="#334155"
                        TextColor="White"
                        FontFamily="InterSemiBold"
                        FontSize="14"
                        CornerRadius="8"
                        HeightRequest="40"
                        Margin="0,8,0,0" />

                <Label Text="You can navigate to other tabs while crests generate"
                       FontFamily="InterRegular"
                       FontSize="11"
                       TextColor="#475569"
                       HorizontalTextAlignment="Center"
                       Margin="0,4,0,0" />
            </VerticalStackLayout>
        </Grid>

        <!-- Cards Revealed (show when: has cards AND (not opening OR viewing live creation)) -->
        <Grid IsVisible="{Binding ShowCardsView}"
              RowDefinitions="Auto,*,Auto"
              Padding="16">

            <!-- Pack Name -->
            <Label Grid.Row="0"
                   Text="{Binding Pack.Name}"
                   FontFamily="OrbitronBold"
                   FontSize="24"
                   TextColor="#fbbf24"
                   HorizontalTextAlignment="Center"
                   Margin="0,20,0,20">
                <Label.Shadow>
                    <Shadow Brush="#fbbf24"
                            Offset="0,0"
                            Radius="15"
                            Opacity="0.4" />
                </Label.Shadow>
            </Label>

            <!-- Cards -->
            <ScrollView Grid.Row="1">
                <FlexLayout x:Name="CardsContainer"
                            Direction="Row"
                            Wrap="Wrap"
                            JustifyContent="Center"
                            AlignItems="Start"
                            BindableLayout.ItemsSource="{Binding Cards}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="vm:CardItem">
                            <!-- Outer glow container for rarity highlight -->
                            <Border StrokeShape="RoundRectangle 16"
                                    Stroke="{Binding RarityColor}"
                                    StrokeThickness="3"
                                    BackgroundColor="Transparent"
                                    Padding="4"
                                    Margin="8">
                                <Border.Shadow>
                                    <Shadow Brush="{Binding RarityColor}"
                                            Offset="0,0"
                                            Radius="20"
                                            Opacity="0.7" />
                                </Border.Shadow>
                                <Grid>
                                    <controls:PlayerCard Player="{Binding Player}"
                                                         CrestImageUrl="{Binding CrestImageUrl}"
                                                         CardSize="Medium"
                                                         Opacity="{Binding IsDuplicate, Converter={StaticResource BoolToOpacityConverter}}">
                                        <controls:PlayerCard.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PackOpeningViewModel}}, Path=ViewCardCommand}"
                                                                  CommandParameter="{Binding}" />
                                        </controls:PlayerCard.GestureRecognizers>
                                    </controls:PlayerCard>
                                    <!-- Duplicate overlay -->
                                    <Border IsVisible="{Binding IsDuplicate}"
                                            BackgroundColor="#CC000000"
                                            StrokeShape="RoundRectangle 12">
                                        <VerticalStackLayout VerticalOptions="Center"
                                                             HorizontalOptions="Center"
                                                             Spacing="4">
                                            <Label Text="DUPLICATE"
                                                   FontFamily="OrbitronBold"
                                                   FontSize="14"
                                                   TextColor="#ef4444"
                                                   HorizontalTextAlignment="Center" />
                                            <Label Text="{Binding DuplicateCoins, StringFormat='+{0} coins'}"
                                                   FontFamily="InterSemiBold"
                                                   FontSize="16"
                                                   TextColor="#22c55e"
                                                   HorizontalTextAlignment="Center" />
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>
            </ScrollView>

            <!-- Bottom Actions -->
            <VerticalStackLayout Grid.Row="2" Spacing="12" Margin="0,20,0,0">
                <Label Text="Tap a card to view details"
                       FontFamily="InterRegular"
                       FontSize="12"
                       TextColor="#64748b"
                       HorizontalTextAlignment="Center" />

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <!-- Close -->
                    <Button Grid.Column="0"
                            Text="Close"
                            Command="{Binding GoBackCommand}"
                            BackgroundColor="#334155"
                            TextColor="White"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50" />

                    <!-- Sell All -->
                    <Button Grid.Column="1"
                            Text="{Binding SellAllValue, StringFormat='Sell All ({0})'}"
                            Command="{Binding SellAllCommand}"
                            BackgroundColor="#dc262620"
                            TextColor="#ef4444"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50"
                            BorderColor="#ef4444"
                            BorderWidth="1" />

                    <!-- Open Another -->
                    <Button Grid.Column="2"
                            Text="Open Another"
                            Command="{Binding OpenAnotherCommand}"
                            BackgroundColor="#f97316"
                            TextColor="White"
                            FontFamily="InterSemiBold"
                            CornerRadius="12"
                            HeightRequest="50" />
                </Grid>
            </VerticalStackLayout>
        </Grid>

        <!-- Empty State (shown when no pack is being opened) -->
        <Grid IsVisible="{Binding ShowEmptyState}"
              VerticalOptions="Center"
              HorizontalOptions="Center">
            <VerticalStackLayout Spacing="16" Padding="40">
                <Label Text="No pack selected"
                       FontFamily="InterSemiBold"
                       FontSize="18"
                       TextColor="#64748b"
                       HorizontalTextAlignment="Center" />
                <Button Text="Go to Pack Store"
                        Command="{Binding GoBackCommand}"
                        BackgroundColor="#f97316"
                        TextColor="White"
                        FontFamily="InterSemiBold"
                        CornerRadius="12"
                        HeightRequest="50"
                        WidthRequest="200" />
            </VerticalStackLayout>
        </Grid>

    </Grid>
</ContentPage>
