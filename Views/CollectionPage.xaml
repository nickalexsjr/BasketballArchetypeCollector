<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BasketballArchetypeCollector.ViewModels"
             xmlns:controls="clr-namespace:BasketballArchetypeCollector.Controls"
             xmlns:models="clr-namespace:BasketballArchetypeCollector.Models"
             xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
             x:Class="BasketballArchetypeCollector.Views.CollectionPage"
             x:DataType="vm:CollectionViewModel"
             BackgroundColor="#0a0a0f"
             Shell.NavBarIsVisible="False"
             ios:Page.UseSafeArea="True">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header with gradient feel -->
        <Border Grid.Row="0"
                BackgroundColor="#0f172a"
                Padding="20,16"
                StrokeThickness="0">
            <Border.Shadow>
                <Shadow Brush="#000000"
                        Offset="0,4"
                        Radius="8"
                        Opacity="0.3" />
            </Border.Shadow>
            <Grid ColumnDefinitions="*,Auto">
                <VerticalStackLayout Grid.Column="0" Spacing="4">
                    <Label Text="COLLECTION"
                           FontFamily="OrbitronBold"
                           FontSize="26"
                           TextColor="White">
                        <Label.Shadow>
                            <Shadow Brush="#f97316"
                                    Offset="0,0"
                                    Radius="10"
                                    Opacity="0.3" />
                        </Label.Shadow>
                    </Label>
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding CollectionCount}"
                               FontFamily="OrbitronBold"
                               FontSize="16"
                               TextColor="#f97316" />
                        <Label Text="cards owned"
                               FontFamily="InterRegular"
                               FontSize="14"
                               TextColor="#64748b"
                               VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <controls:CoinDisplay Grid.Column="1"
                                      Coins="{Binding Coins}"
                                      VerticalOptions="Center" />
            </Grid>
        </Border>

        <!-- Filters Section -->
        <VerticalStackLayout Grid.Row="1"
                             Padding="16,12"
                             Spacing="12"
                             BackgroundColor="#0a0a0f">
            <!-- Search Bar with icon feel -->
            <Border StrokeShape="RoundRectangle 12"
                    BackgroundColor="#1e293b"
                    Stroke="#334155"
                    StrokeThickness="1"
                    Padding="16,12">
                <Grid ColumnDefinitions="Auto,*">
                    <Label Grid.Column="0"
                           Text="ðŸ”"
                           FontSize="16"
                           VerticalOptions="Center"
                           Margin="0,0,12,0" />
                    <Entry Grid.Column="1"
                           Text="{Binding SearchQuery}"
                           Placeholder="Search by name or team..."
                           PlaceholderColor="#64748b"
                           TextColor="White"
                           FontFamily="InterRegular"
                           FontSize="15"
                           BackgroundColor="Transparent" />
                </Grid>
            </Border>

            <!-- Filter Pills -->
            <ScrollView Orientation="Horizontal"
                        HorizontalScrollBarVisibility="Never">
                <HorizontalStackLayout Spacing="10">
                    <!-- Rarity Filter -->
                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="#1e293b"
                            Stroke="#334155"
                            StrokeThickness="1"
                            Padding="12,8">
                        <HorizontalStackLayout Spacing="6">
                            <Label Text="âœ¨"
                                   FontSize="12"
                                   VerticalOptions="Center" />
                            <Picker Title="Rarity"
                                    SelectedItem="{Binding SelectedRarity}"
                                    ItemsSource="{Binding RarityOptions}"
                                    TextColor="White"
                                    TitleColor="#94a3b8"
                                    FontFamily="InterSemiBold"
                                    FontSize="13"
                                    BackgroundColor="Transparent"
                                    WidthRequest="80" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Era Filter -->
                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="#1e293b"
                            Stroke="#334155"
                            StrokeThickness="1"
                            Padding="12,8">
                        <HorizontalStackLayout Spacing="6">
                            <Label Text="ðŸ“…"
                                   FontSize="12"
                                   VerticalOptions="Center" />
                            <Picker Title="Era"
                                    ItemsSource="{Binding EraOptions}"
                                    SelectedIndex="0"
                                    SelectedItem="{Binding SelectedEra}"
                                    TextColor="White"
                                    TitleColor="#94a3b8"
                                    FontFamily="InterSemiBold"
                                    FontSize="13"
                                    BackgroundColor="Transparent"
                                    WidthRequest="70" />
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Sort Filter -->
                    <Border StrokeShape="RoundRectangle 10"
                            BackgroundColor="#1e293b"
                            Stroke="#334155"
                            StrokeThickness="1"
                            Padding="12,8">
                        <HorizontalStackLayout Spacing="6">
                            <Picker Title="Sort"
                                    SelectedItem="{Binding SelectedSort}"
                                    ItemsSource="{Binding SortOptions}"
                                    TextColor="White"
                                    TitleColor="#94a3b8"
                                    FontFamily="InterSemiBold"
                                    FontSize="13"
                                    BackgroundColor="Transparent"
                                    WidthRequest="70" />
                            <Border StrokeShape="RoundRectangle 6"
                                    BackgroundColor="#334155"
                                    Padding="6,4">
                                <Label Text="{Binding SortDescending, Converter={StaticResource SortDirectionConverter}}"
                                       FontSize="12"
                                       TextColor="#f97316"
                                       VerticalOptions="Center">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ToggleSortOrderCommand}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </Border>
                        </HorizontalStackLayout>
                    </Border>
                </HorizontalStackLayout>
            </ScrollView>
        </VerticalStackLayout>

        <!-- Player Grid -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding LoadPlayersCommand}"
                     RefreshColor="#f97316"
                     BackgroundColor="#0a0a0f">
            <CollectionView ItemsSource="{Binding Players}"
                            Margin="16,8,16,16">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="3"
                                     HorizontalItemSpacing="8"
                                     VerticalItemSpacing="16" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Player">
                        <controls:PlayerCard Player="{Binding}"
                                             CrestImageUrl="{Binding Id, Converter={StaticResource PlayerIdToCrestConverter}}"
                                             CardSize="Small">
                            <controls:PlayerCard.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollectionViewModel}}, Path=NavigateToPlayerCommand}"
                                                      CommandParameter="{Binding}" />
                            </controls:PlayerCard.GestureRecognizers>
                        </controls:PlayerCard>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="40"
                                         Spacing="12">
                        <Label Text="ðŸƒ"
                               FontSize="48"
                               HorizontalTextAlignment="Center" />
                        <Label Text="No cards found"
                               FontFamily="OrbitronBold"
                               FontSize="20"
                               TextColor="#64748b"
                               HorizontalTextAlignment="Center" />
                        <Label Text="Try adjusting your filters or open some packs!"
                               FontFamily="InterRegular"
                               FontSize="14"
                               TextColor="#475569"
                               HorizontalTextAlignment="Center" />
                        <Button Text="Open Packs"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollectionViewModel}}, Path=GoToPacksCommand}"
                                BackgroundColor="#f97316"
                                TextColor="White"
                                FontFamily="InterSemiBold"
                                CornerRadius="10"
                                Padding="24,12"
                                Margin="0,8,0,0"
                                HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Loading Overlay -->
        <Grid Grid.Row="2"
              BackgroundColor="#0a0a0f99"
              IsVisible="{Binding IsBusy}">
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="12">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   Color="#f97316"
                                   HeightRequest="50"
                                   WidthRequest="50" />
                <Label Text="Loading collection..."
                       FontFamily="InterRegular"
                       FontSize="14"
                       TextColor="#94a3b8"
                       HorizontalTextAlignment="Center" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
